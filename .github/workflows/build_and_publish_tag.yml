name: BUILD AND PUBLISH TAG

#curl -X POST -H "Accept: application/vnd.github.v3+json" \
#     -H "Authorization: token GITHUB_PERSONAL_ACCESS_TOKEN" \
#     https://api.github.com/repos/plugfox/docker_flutter/dispatches \
#     -d '{"event_type":"build_flutter","client_payload":{"version":"3.19.0"}}'

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Flutter version from https://github.com/flutter/flutter/tags"
        required: true

  repository_dispatch:
    types: [build_flutter]

env:
  DOCKER_IMAGE: plugfox/flutter

jobs:
  build_and_push:
    name: "Build and push"
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: üì¶ Checkout the repo
        uses: actions/checkout@v4

      - name: üîÑ Extract Flutter version
        id: extract_version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "FLUTTER_VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          elif [ -n "${{ github.event.client_payload.version }}" ]; then
            echo "FLUTTER_VERSION=${{ github.event.client_payload.version }}" >> $GITHUB_ENV
          else
            echo "‚ùå No Flutter version provided!"; exit 1
          fi

      - name: üê≥ Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üì¶ Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_LOGIN_USERNAME }}
          password: ${{ secrets.DOCKER_LOGIN_PASSWORD }}

      #- name: üì¶ Log in to GitHub Container Registry (GHCR) [Optional]
      #  uses: docker/login-action@v3
      #  with:
      #    registry: ghcr.io
      #    username: ${{ github.actor }}
      #    password: ${{ secrets.GITHUB_TOKEN }}

      - name: üöÄ Build and push Flutter Base image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./dockerfiles/flutter.dockerfile
          platforms: linux/arm64,linux/amd64
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ env.FLUTTER_VERSION }}
          #  ghcr.io/${{ github.repository_owner }}/flutter:latest
          #  ghcr.io/${{ github.repository_owner }}/flutter:${{ env.FLUTTER_VERSION }}
          build-args: |
            VERSION=${{ env.FLUTTER_VERSION }}
            UBUNTU_VERSION=24.04
            FLUTTER_HOME=/opt/flutter
            PUB_CACHE=/var/cache/pub
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:cache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:cache,mode=max

      - name: üöÄ Build and push Flutter Web image (uses base)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./dockerfiles/flutter_web.dockerfile
          platforms: linux/arm64,linux/amd64
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ env.FLUTTER_VERSION }}-web
          #  ghcr.io/${{ github.repository_owner }}/flutter:${{ env.FLUTTER_VERSION }}-web
          build-args: |
            VERSION=${{ env.FLUTTER_VERSION }}
            BASE_IMAGE=${{ env.DOCKER_IMAGE }}:${{ env.FLUTTER_VERSION }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:cache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:cache,mode=max

      - name: üöÄ Build and push Flutter Android image (uses base)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./dockerfiles/flutter_android.dockerfile
          platforms: linux/arm64,linux/amd64
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ env.FLUTTER_VERSION }}-android
          #  ghcr.io/${{ github.repository_owner }}/flutter:${{ env.FLUTTER_VERSION }}-android
          build-args: |
            VERSION=${{ env.FLUTTER_VERSION }}
            BASE_IMAGE=${{ env.DOCKER_IMAGE }}:${{ env.FLUTTER_VERSION }}
            ANDROID_SDK_TOOLS_VERSION=11076708
            ANDROID_PLATFORM_VERSION=35
            ANDROID_BUILD_TOOLS_VERSION=35.0.0
            ANDROID_HOME=/opt/android
            UBUNTU_VERSION=24.04
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:cache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:cache,mode=max
